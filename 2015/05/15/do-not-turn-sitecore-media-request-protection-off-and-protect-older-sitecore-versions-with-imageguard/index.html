<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1314&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Do not turn Sitecore Media Request protection off and protect older Sitecore versions with ImageGuard | Codality</title>
<meta name="description" content="[noun] - \ko-&#39;da-la-te\ - Code and Effect - solving problems with just enough amount of code - by Adam Najmanowicz">
<meta name="generator" content="Hugo 0.156.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&family=Alegreya+Sans:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">

<script>
  (function(){var s=localStorage.getItem('theme-preference');var t=s==='dark'||s==='light'?s:(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');document.documentElement.setAttribute('data-theme',t)})();
</script>

      <script src="/js/main.js"></script>



</head>
<body>
  <div class="site-wrapper">
    <header class="site-header">
      <div class="header-inner">
  <div class="header-top">
    <nav class="site-navigation" aria-label="Main Navigation">
      
  <nav>
    <ul>
    <li>
      <a href="/">Home</a>
    </li>
    <li>
      <a href="/about/">About me</a>
    </li>
    <li>
      <a href="/downloads/">Downloads</a>
    </li>
    </ul>
  </nav>

    </nav>
    
    <nav class="social-navigation" aria-label="Social Links">
      <ul>
        <li><a href="https://github.com/AdamNaj" title="GitHub"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></a></li>
        <li><a href="https://www.linkedin.com/in/najmanowicz/" title="LinkedIn"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a></li>
        <li><a href="http://www.twitter.com/AdamNaj" title="Twitter"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/></svg></a></li>
        <li><a href="https://www.facebook.com/adam.najmanowicz" title="Facebook"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg></a></li>
        <li><a href="https://www.instagram.com/adamnajmanowicz/" title="Instagram"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg></a></li>
      </ul>
    </nav>
    
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
      <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    </button>
  </div>
  <div class="site-branding">
    <p class="site-title"><a href="/">Codality</a></p>
    
    <p class="site-tagline">[noun] - \ko-&#39;da-la-te\ - Code and Effect - solving problems with just enough amount of code - by Adam Najmanowicz</p>
    
    <hr class="header-separator"><nav class="tag-cloud" aria-label="Category Cloud"><a href="/categories/best-practices/" style="font-size: 14px;" title="best practices (14 posts)">Best Practices</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/blog-navigator/" style="font-size: 12px;" title="blog navigator (8 posts)">Blog Navigator</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/cms/" style="font-size: 24px;" title="cms (79 posts)">CMS</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/cms-ux/" style="font-size: 12px;" title="cms ux (8 posts)">CMS UX</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/code-samples/" style="font-size: 16px;" title="code samples (35 posts)">Code Samples</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/continuous-deployment/" style="font-size: 11px;" title="continuous deployment (4 posts)">Continuous Deployment</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/desktop-customization/" style="font-size: 11px;" title="desktop customization (4 posts)">Desktop Customization</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/downloadable/" style="font-size: 14px;" title="downloadable (22 posts)">Downloadable</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/epicode/" style="font-size: 14px;" title="epicode (16 posts)">EPiCode</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/episerver/" style="font-size: 18px;" title="episerver (41 posts)">EPiServer</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/faceted-navigation/" style="font-size: 11px;" title="faceted navigation (5 posts)">Faceted Navigation</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/icondeveloper/" style="font-size: 11px;" title="icondeveloper (3 posts)">IconDeveloper</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/internet-information-services/" style="font-size: 12px;" title="internet information services (11 posts)">Internet Information Services</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/lifestyle/" style="font-size: 14px;" title="lifestyle (13 posts)">Lifestyle</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/microsoft-sqlserver/" style="font-size: 12px;" title="microsoft sqlserver (6 posts)">Microsoft SqlServer</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/mobile/" style="font-size: 11px;" title="mobile (4 posts)">Mobile</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/open-source/" style="font-size: 16px;" title="open source (24 posts)">Open Source</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/powershell/" style="font-size: 18px;" title="powershell (43 posts)">PowerShell</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/rants/" style="font-size: 12px;" title="rants (7 posts)">Rants</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/scripting/" style="font-size: 18px;" title="scripting (43 posts)">Scripting</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/security/" style="font-size: 11px;" title="security (2 posts)">Security</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/sitecore/" style="font-size: 18px;" title="sitecore (38 posts)">Sitecore</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/skinning/" style="font-size: 12px;" title="skinning (10 posts)">Skinning</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/skinstudio/" style="font-size: 14px;" title="skinstudio (13 posts)">SkinStudio</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/software-development/" style="font-size: 28px;" title="software development (99 posts)">Software Development</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/solution/" style="font-size: 18px;" title="solution (42 posts)">Solution</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/stardock/" style="font-size: 16px;" title="stardock (25 posts)">Stardock</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/tooling/" style="font-size: 14px;" title="tooling (13 posts)">Tooling</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/visual-studio/" style="font-size: 12px;" title="visual studio (7 posts)">Visual Studio</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/webparts/" style="font-size: 11px;" title="webparts (2 posts)">WebParts</a><span class="tag-cloud-sep" aria-hidden="true">&middot;</span><a href="/categories/windowblinds/" style="font-size: 12px;" title="windowblinds (12 posts)">WindowBlinds</a></nav>
    <hr class="tag-cloud-separator"></div>
</div>

    </header>
    <div class="site-main">
      <aside class="sidebar">
  <div class="widget">
    <h2 class="widget-title">Search</h2>
    <form class="search-form" action="http://localhost:1314/search/" method="get">
      <input type="search" class="search-field" placeholder="Search ..." name="q">
    </form>
  </div>

  
  <div class="widget widget-mvp">
    <a href="https://mvp.sitecore.com/en/Directory/Profile?id=e416ef1dabf5468ff4fa08dd30f068bb" title="Sitecore Technology MVP 2026">
      <img src="/images/sitecore-mvp-2026-technology.png" alt="Sitecore Technology MVP 2026" class="mvp-badge" width="250">
    </a>
    
    <div class="mvp-badges-history">
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2017-Technology.png" alt="MVP Badge 2017" class="mvp-badge-small">
        <span class="mvp-badge-year">2017</span>
      </div>
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2016-Technology.png" alt="MVP Badge 2016" class="mvp-badge-small">
        <span class="mvp-badge-year">2016</span>
      </div>
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2015-Technology.png" alt="MVP Badge 2015" class="mvp-badge-small">
        <span class="mvp-badge-year">2015</span>
      </div>
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2014-Technology.png" alt="MVP Badge 2014" class="mvp-badge-small">
        <span class="mvp-badge-year">2014</span>
      </div>
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2013-Technology.png" alt="MVP Badge 2013" class="mvp-badge-small">
        <span class="mvp-badge-year">2013</span>
      </div>
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2012-Technology.png" alt="MVP Badge 2012" class="mvp-badge-small">
        <span class="mvp-badge-year">2012</span>
      </div>
      
      
      
      <div class="mvp-badge-item">
        <img src="/images/mvp/2011-Technology.png" alt="MVP Badge 2011" class="mvp-badge-small">
        <span class="mvp-badge-year">2011</span>
      </div>
      
    </div>
    
  </div>
  

  
</aside>

      <main class="content-area">
        
  <article class="post single">
    <div class="content-area">
      <header class="entry-header">
        <h1 class="entry-title">Do not turn Sitecore Media Request protection off and protect older Sitecore versions with ImageGuard</h1>
        <div class="entry-meta">
          <time datetime="2015-05-15T00:00:45&#43;00:00">
            May 15, 2015
          </time>
          
          <span class="author">by Adam Najmanowicz</span>
          
          <span class="reading-time">
            <svg class="reading-time-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            10 min read
          </span>
        </div>
        
        <div class="entry-categories">
          
          <a href="http://localhost:1314/categories/cms/" class="category-badge">CMS</a>
          
          <a href="http://localhost:1314/categories/open-source/" class="category-badge">Open Source</a>
          
          <a href="http://localhost:1314/categories/security/" class="category-badge">Security</a>
          
          <a href="http://localhost:1314/categories/sitecore/" class="category-badge">Sitecore</a>
          
          <a href="http://localhost:1314/categories/software-development/" class="category-badge">Software Development</a>
          
          <a href="http://localhost:1314/categories/solution/" class="category-badge">Solution</a>
          
          <a href="http://localhost:1314/categories/visual-studio/" class="category-badge">Visual Studio</a>
          
        </div>
        
      </header>

      <div class="entry-content">
        <p><a href="/images/SitecorePatched.png"><img src="/images/SitecorePatched_thumb.png" alt="SitecorePatched" title="SitecorePatched" class="alignright" width="237" height="240" /></a></p>
<p><em>The post is related to the image resize vulnerability fix introduced in Sitecore 7.5. To read more about the Sitecore fix go to the</em> <a href="http://sdn.sitecore.net/Products/Sitecore%20V5/Sitecore%20CMS%207/ReleaseNotes/ChangeLog.aspx"><em>Release notes page</em></a> <em>and search for ?Media request protection?. While I was holding off for a number of months on the publication of the post as it puts the attack vector in plainer sight that I would like it to be (<a href="http://www.seanholmesby.com/images-not-resizing-in-sitecore-7-5-sitecore-8-0/">while the community</a> figured out <a href="http://sitecorepromenade.blogspot.se/2014/11/sitecore-75-image-resizing-changes.html">how to work with Media Resizing in a neat way</a>) - but recently I&rsquo;ve seen voices raised considering <a href="http://coresighted.net/2015/05/13/sitecore-media-request-protection-gone-wild/">turning the Media Request protection off</a> which I hope you will not be doing after reading this post. The post will also tell you how to enable such security on your older versions of Sitecore.</em>
So here&rsquo;s the story&hellip;. At some point in <a href="http://www.cognifide.com/">Cognifide</a> we have performed a research around Sitecore security and one of my colleagues (<a href="https://twitter.com/MarasM">Marek</a>)  found out that you could easily kill any Sitecore instance by performing an image resize attack on it. While the CMS did some rudimentary checks and limited the values of height and width you could still perform an attack by harvesting the images from the site and perform multiple parallel &amp; iterative size increase or just plain use the scale parameter to achieve any image size. A result of such attack would be a a denial of service due to 100% CPU &amp; memory usage and would potentially allow for filling the server drive by creating the endless number of scaling calls.
Marek was even kind enough to provide a proof of concept code that confirmed the hypothesis by performing attack on a few of our internal servers. The program would load the home page; parse to find images linked from it and perform resizing of the images in a number threads.
[</p>
<p>](/wp-content/uploads/2020/08/bridge_collapsing.webm)</p>
<p><em>Psst? <a href="https://twitter.com/mike_i_reynolds">Mike</a> made me add the image &ndash; supposedly without it I&rsquo;m not as cool as <a href="https://twitter.com/JLDeveloper27/status/509465224907206656">Stephen</a>!</em></p>
<p>Following the discovery I&rsquo;ve attempted to remedy the problem and as a consequence came up with the solution which I have recently put on <a href="https://github.com/AdamNaj/Cognifide.SiteCore.ImageGuard/">GitHub - ImageGuard</a> which signs the rendered media links that use any of the resizing/scaling capabilities and filters all request that try to resize/scale, allowing the sizing only when the hash matches and provided it to Sitecore.
This solution is nowhere as complete as the one that was later provided by Sitecore - starting from version 7.5 &ndash; still I think it&rsquo;s still worth making it public to allows for older versions of Sitecore to be guarded against this type of attacks.</p>
<blockquote>
<h2 id="disclaimer">Disclaimer</h2>
<p>Following post describes the solution I have provided to Sitecore some time ago (and is very similar in nature to what Sitecore finally implemented) and should protect you against this kind of attacks. You should only use it if migrating to a newer version of Sitecore is not an option for your company or a client &ndash; otherwise I suggest you consider upgrading your Sitecore solution to Sitecore 7.5 or newer. Obviously before deploying it on production you need to do your due diligence testing if it does not interfere with any other functionality of your Sitecore deployment. I take no responsibility for any adverse effects and for that matter any negative effects it might have for your site operation. The <a href="https://github.com/AdamNaj/Cognifide.SiteCore.ImageGuard/">full source code have been provided on GitHub</a> for your review and any corrections that the code might require to work properly within your solution. Feel free to fork the code &ndash; just make sure you and your clients are protected!</p>
</blockquote>
<p>I&rsquo;ve been thinking about the different solutions like white-listing or managing allowed sizes and following are my thoughts of benefits and drawbacks of using the signed sizing (that Sitecore ultimately agreed with):</p>
<ul>
<li>One major benefit of using the links signing is that its completely maintenance free. The CMS generated links are signed automatically and there is no process required for approval or white-listing sizes and thus there is no need for the authors to jump through any hoops when they resize the image in the rich text editor or even be careful to use one of the unapproved sizes.</li>
<li>Signing is immediately compatible with the site content - no need to look through the content to find any unapproved or not white-listed sizes. All links will automatically get signed.</li>
<li>The method has only minimal impact on the CMS performance as it is only employed when the image size is actually changed (the non resized images don&rsquo;t get the hash attached).</li>
<li>It immediately protects the Sitecore instance from ANY resizing attack (other methods potentially allow for trial-error to find out the allowed sizes and then resizing all of the assets into all allowed sizes - granted - a very limited attack surface when compared to the previous free-for-all).</li>
<li>One drawback that I realize the method has - the links cannot be easily calculated from a JS client (possible though cumbersome and reveals the shared secret to the public within the script).</li>
<li>While white-listing methods definitely have the benefit of being immediately and effortlessly usable from front-end (JavaScript). In those cases though I would suggest only limiting the white-list to one dimension (either height, width or scale) or it can be quite limiting (as each white-listed size would only apply to images of specific ratio, or cause ratio distortion). Another potential problem is that of scaling parameter which is a float and might be tough to white-list due to the float granularity.</li>
</ul>
<h2 id="what-should-i-do-to-use-it">What should I do to use it?</h2>
<p>You can protect any Sitecore instance simply by dropping the <a href="https://github.com/AdamNaj/Cognifide.SiteCore.ImageGuard/blob/master/bin/Release/Cognifide.ImageGuard.dll" title="https://github.com/AdamNaj/Cognifide.SiteCore.ImageGuard/blob/master/bin/Release/Cognifide.SiteCore.ImageGuard.dll">Cognifide.ImageGuard.dll</a> in your bin folder and dropping the <a href="https://github.com/AdamNaj/Cognifide.SiteCore.ImageGuard/blob/master/App_Config/Include/Cognifide.ImageGuard.config">Cognifide.ImageGuard.config</a> file in the Sitecore App_Config\Include\ include folder. The hashes generated are salted with the shared secret that you can find in the include file  - just with the Sitecore provided solution <strong>make sure that you change the shared secret so that your instance does not use the same hash salt and consequently allow any attacker to reproduce the hashes your instance would be using</strong>.
If the hash does not match the Sitecore instance will simply return the unprocessed media not creating any additional load on the server and any additional cache entry. <strong>So the worst case scenario is that you will get the original image out.</strong></p>
<h2 id="how-does-it-work">How does it work?</h2>
<p>On the outgoing side - the solution plugs into the renderField - field rendering pipeline and looks for any <img> tags that contain the dangerous parameters and hashes them together with the salt and the image item id. It leaves all the unmodified images untouched.
The solution has been written with performance in mind. My tests did not show any measurable impact. The pipeline module works as follows:</p>
<ul>
<li>does the field contain any &ldquo;&lt;img&rdquo; tag? if not  - pass through the original markup
<ul>
<li>for each &ldquo;&lt;img&rdquo; check it&rsquo;s content to see if there are any parameters  - if the field contains no <img>  tags with parameters the <strong>rendered text is simply returned to the pipeline</strong></li>
<li>if the link contains parameters - check if it&rsquo;s any of the abusable parameters - if not - <strong>return the string untouched</strong> to the pipeline.</li>
</ul>
</li>
<li>Up till this moment <strong>no string cutting and copying</strong> has been performed and all searches are performed on the smallest chunks of the originally rendered texts that are possible, so it&rsquo;s very fast whenever the signing is not required.
<ul>
<li>if the content contains any <img> tag with abusable parameters - the URLs are signed. This process is fairly lightweight</li>
</ul>
</li>
</ul>
<p>On the receiving side creates a thin layer over the the mediaLibrary/requestParser and when an image with modifiers is requested it creates the hash again and compares the hash to the one sent from the client. If the hashes are not identical it will return the original-unchanged image.
The following factors influence the hash:</p>
<ul>
<li>width (w=)</li>
<li>height (h=)</li>
<li>max width (mw=)</li>
<li>max height (mh=)</li>
<li>scale (sc=)</li>
<li>media item id</li>
</ul>
<h2></h2>
<h2 id="concerns">Concerns?</h2>
<p>Following is a list of some concerns that were raised when we worked with Sitecore on the solution.</p>
<h3 id="it-only-covers-one-case-the-fieldrenderer-there-are-more-cases-where-it-can-happen">It only covers one case, The FieldRenderer. There are more cases where it can happen</h3>
<p>Agreed. Since it&rsquo;s not a vendor solution it will not cover all situations without parsing all outgoing HTML pages which would be extremely slow. Arguably even a systemic solution (using hashing) would find it hard to deal with all of those without the partner developers making proper use of it. The code solves problem with content, it does not solve problem with the solution code itself. e.g. we&rsquo;ve already identified that it can impact the Content Editor as it creates its thumbnails and enforces the resize in code. The solution provided couldn&rsquo;t be perfect until it got included within the product with a through code analysis (the ideal point for it would be to modify the Sitecore.Resources.Media.MediaUrlOptions to include the signature), however this was not doable at the time of writing as the class is instantiated explicitly in a number of places (an IoC solution would be super cool for that!). The worst case scenario in those situations would be that the original image would be transferred and the scaling will happen on the client side.</p>
<h3 id="but-direct-links-to-the-original-images-still-work">But direct links to the original images still work?</h3>
<p>This is very much the intentional behavior. The solution is not designed to deal with deep linking, but rather with the consequences of resizing attacks. The consequences of a &ldquo;sc=##.####&rdquo; attack are as follows:</p>
<ul>
<li>immediate increase in memory consumption (limited to the duration of attack - the server will eventually recover once the attack ceases )</li>
<li>immediate increase in CPU load (limited to the duration of attack - the server will eventually recover once the attack ceases)</li>
<li>disk space consumption - to the limit of the drive or user quota. (the server will likely not recover from this - potentially to the point of inability to boot)</li>
</ul>
<p>The solution deals with those issues exclusively. It attempts to be completely maintenance free (no user involvement whatsoever after the code is deployed) and to be of minimum impact to the system performance and operations.</p>
<h3 id="its-a-hotfix-untested-by-the-product-team">It&rsquo;s a hotfix untested by the product team</h3>
<p>That is very true &ndash; this solution is quite similar to what Sitecore ultimately went with but as I stated above it does not every case (e.g. XSLT or MCV). If you can move to Sitecore 7.5 and make use of the Sitecore&rsquo;s final solution &ndash; you should.</p>
<h3 id="the-code-looks-quite-cpu-intensive">The code looks quite CPU intensive</h3>
<p>This is very situational. In each client&rsquo;s scenario the behavior may vary depending mostly on how much scaling your content contains thus how much HTML needs to be rewritten. The solution is still open for more optimizations. Testing on our site, the solution didn&rsquo;t produce any measurable slowdowns. It&rsquo;s worth mentioning again that the solution works within the constraints of an external module and without the ability to replace the class mentioned above (or being otherwise included with the very product) it has to rely on parsing the rendered HTML, which will always have some overhead.</p>
<h3 id="how-unique-are-the-hashes">How unique are the hashes?</h3>
<p>The solution uses SHA1 algorithm, included with the .Net framework and AFAIK is considered a fairly good hashing algorithm and an industry standard. One important thing is that the hashes do NOT need to be globally unique. The hash only needs to be unique in the context of a single media item usage (ID+width+height+scale+mw+mh) - <strong>single usage must always result in the same hash</strong>.
We decided against going public with our discovery at the time of discovery as it may have negatively affected Sitecore customers.
The code is battle tested as Cognifide clients were always protected using this solution since the moment it was developed.</p>

      </div>

      <footer class="entry-footer">
        

        <nav class="post-navigation">
          
          <div class="nav-previous">
            <a href="/2015/05/05/turn-your-sitecore-powershell-reports-into-applications-with-action-scripts/">&laquo; Turn your Sitecore PowerShell reports into applications with Action Scripts</a>
          </div>
          
          
          <div class="nav-next">
            <a href="/2016/08/03/roll-out-item-branches-en-masse-using-sitecore-powershell-extensions/">Roll out multilingual item branches en masse using Sitecore PowerShell Extensions &raquo;</a>
          </div>
          
        </nav>
      </footer>

      
<div class="comments">
  <h2 class="comments-title">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:1314/2015/05/15/do-not-turn-sitecore-media-request-protection-off-and-protect-older-sitecore-versions-with-imageguard/";
      this.page.identifier = "/2015/05/15/do-not-turn-sitecore-media-request-protection-off-and-protect-older-sitecore-versions-with-imageguard/";
      this.page.identifier = '3765624860';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://codality.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </div>
  </article>

      </main>
    </div>
    <footer class="site-footer">
      <div class="footer-inner">
  <p>&copy; 1999-2026 - <a href="/">Adam Najmanowicz</a></p>
  
</div>

    </footer>
  </div>
  <button class="back-to-top" id="back-to-top" aria-label="Back to top" title="Back to top">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
  </button>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.highlight').forEach(function(block) {
      block.style.position = 'relative';
      var btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.setAttribute('aria-label', 'Copy code');
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      block.appendChild(btn);
      btn.addEventListener('click', function() {
        var code = block.querySelector('td:last-child code') || block.querySelector('code');
        if (code) {
          navigator.clipboard.writeText(code.textContent).then(function() {
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
            setTimeout(function() {
              btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
            }, 2000);
          });
        }
      });
    });
  });
  </script>
  <script>
  (function() {
    var btn = document.getElementById('back-to-top');
    if (!btn) return;
    var visible = false;
    window.addEventListener('scroll', function() {
      var shouldShow = window.scrollY > 400;
      if (shouldShow !== visible) {
        visible = shouldShow;
        btn.classList.toggle('visible', visible);
      }
    }, { passive: true });
    btn.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  })();
  </script>
  <div class="lightbox-overlay" id="lightbox">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close lightbox">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <div class="lightbox-content" id="lightbox-content"></div>
  </div>
  <script>
  (function() {
    var overlay = document.getElementById('lightbox');
    var content = document.getElementById('lightbox-content');
    var closeBtn = document.getElementById('lightbox-close');
    var imgExts = /\.(jpe?g|png|gif|webp|svg|bmp|avif)(\?.*)?$/i;
    var vidExts = /\.(mp4|webm|ogg)(\?.*)?$/i;

    function open(href) {
      content.innerHTML = '';
      if (imgExts.test(href)) {
        var img = document.createElement('img');
        img.src = href;
        img.alt = '';
        content.appendChild(img);
      } else if (vidExts.test(href)) {
        var vid = document.createElement('video');
        vid.src = href;
        vid.controls = true;
        vid.autoplay = true;
        content.appendChild(vid);
      } else {
        return false;
      }
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      return true;
    }

    function close() {
      overlay.classList.remove('active');
      document.body.style.overflow = '';
      var vid = content.querySelector('video');
      if (vid) vid.pause();
    }

    document.addEventListener('click', function(e) {
      var link = e.target.closest('a[href]');
      if (!link) return;
      var href = link.getAttribute('href');
      if (imgExts.test(href) || vidExts.test(href)) {
        e.preventDefault();
        open(href);
      }
    });

    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      close();
    });

    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) close();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) close();
    });
  })();
  </script>
  <script id="dsq-count-scr" src="https://codality.disqus.com/count.js" async></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    var mermaidBlocks = document.querySelectorAll('pre > code.language-mermaid');
    if (mermaidBlocks.length > 0) {
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js';
      s.onload = function() {
        var mermaidTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default';
        mermaid.initialize({ startOnLoad: false, theme: mermaidTheme });
        mermaidBlocks.forEach(function(block) {
          var pre = block.parentElement;
          var div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = block.textContent;
          pre.parentNode.replaceChild(div, pre);
        });
        mermaid.run();
      };
      document.head.appendChild(s);
    }
  });
  </script>
</body>
</html>
